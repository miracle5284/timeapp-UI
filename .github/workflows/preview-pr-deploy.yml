name: PR Preview Deploy (Isolated App)

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches: [master]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  preview:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment:
      name: preview

    steps:
      - uses: actions/checkout@v4

      - name: Set variables
        id: vars
        run: |
          echo "app=pr-${{ github.event.number }}-chrona-frontend" >> $GITHUB_OUTPUT
          echo "plan=pr-${{ github.event.number }}-chrona-plan" >> $GITHUB_OUTPUT
          VALUE=$(az keyvault secret show --vault-name ${{ secrets.KEY_VAULT_NAME }} --name "BASE-URL" --query "value" -o tsv)
          echo "backend_url=$VALUE" >> $GITHUB_OUTPUT

      - name: Build & Push Docker Image
        run: |
          docker build \
            --build-arg BACKEND_URL=${{ steps.vars.outputs.backend_url }} \
            -t ${{ secrets.REGISTRY_NAME }}/chrona-frontend:pr-${{ github.event.number }} .
          echo ${{ secrets.ACR_PASSWORD }} | docker login ${{ secrets.REGISTRY_NAME }} -u ${{ secrets.ACR_USERNAME }} --password-stdin
          docker push ${{ secrets.REGISTRY_NAME }}/chrona-frontend:pr-${{ github.event.number }}

      - name: Azure Login
        uses: azure/login@v2.2.0
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Delete existing app/plan if already present
        run: |
          APP=${{ steps.vars.outputs.app }}
          PLAN=${{ steps.vars.outputs.plan }}
          RG=${{ secrets.AZURE_RG }}

          echo "ðŸ§¹ Checking for existing app: $APP"
          if az webapp show --name "$APP" --resource-group "$RG" &>/dev/null; then
            az webapp delete --name "$APP" --resource-group "$RG"
            echo "âŒ› Waiting for app to be deleted..."
            for i in {1..12}; do
              sleep 10
              if ! az webapp show --name "$APP" --resource-group "$RG" &>/dev/null; then
                echo "âœ… App deleted."
                break
              fi
              echo "â³ Still deleting... ($i/12)"
            done
          else
            echo "No app to delete."
          fi

          echo "ðŸ§¹ Checking for existing plan: $PLAN"
          if az appservice plan show --name "$PLAN" --resource-group "$RG" &>/dev/null; then
            az appservice plan delete --name "$PLAN" --resource-group "$RG" --yes
          else
            echo "No plan to delete."
          fi

      - name: Deploy Infrastructure with Bicep
        run: |
          az deployment group create \
            --resource-group ${{ secrets.AZURE_RG }} \
            --template-file infrastructure/preview-app.bicep \
            --parameters \
              appServiceName=${{ steps.vars.outputs.app }} \
              appServicePlan=${{ steps.vars.outputs.plan }} \
              imageName=${{ secrets.REGISTRY_NAME }}/chrona-frontend:pr-${{ github.event.number }} \
              registryUrl=https://${{ secrets.REGISTRY_NAME }} \
              acrUsername=${{ secrets.ACR_USERNAME }} \
              acrPassword=${{ secrets.ACR_PASSWORD }} 

      - name: Enable Continuous Deployment
        run: |
          az webapp deployment container config \
            --enable-cd true \
            --name ${{ steps.vars.outputs.app }} \
            --resource-group ${{ secrets.AZURE_RG }}

      - name: Update ALLOWED_HOSTS and CORS_ALLOWED_ORIGINS in Vault
        run: |
          APP_URL="https://${{ steps.vars.outputs.app }}.azurewebsites.net"
          VAULT_NAME=${{ secrets.KEY_VAULT_NAME }}

          echo "Fetching existing ALLOWED-HOSTS..."
          EXISTING_ALLOWED=$(az keyvault secret show --vault-name "$VAULT_NAME" --name "ALLOWED-HOSTS" --query "value" -o tsv)

          echo "Fetching existing CORS-ALLOWED-ORIGINS..."
          EXISTING_CORS=$(az keyvault secret show --vault-name "$VAULT_NAME" --name "CORS-ALLOWED-ORIGINS" --query "value" -o tsv)

          echo "Updating ALLOWED_HOSTS..."
          if [[ "$EXISTING_ALLOWED" == *"$APP_URL"* ]]; then
            echo "Already present, skipping."
            UPDATED_ALLOWED="$EXISTING_ALLOWED"
          else
            UPDATED_ALLOWED="${EXISTING_ALLOWED:+$EXISTING_ALLOWED,}$APP_URL"
            az keyvault secret set --vault-name "$VAULT_NAME" --name "ALLOWED-HOSTS" --value "$UPDATED_ALLOWED"
          fi

          echo "Updating CORS_ALLOWED_ORIGINS..."
          if [[ "$EXISTING_CORS" == *"$APP_URL"* ]]; then
            echo "Already present, skipping."
            UPDATED_CORS="$EXISTING_CORS"
          else
            UPDATED_CORS="${EXISTING_CORS:+$EXISTING_CORS,}$APP_URL"
            az keyvault secret set --vault-name "$VAULT_NAME" --name "CORS-ALLOWED-ORIGINS" --value "$UPDATED_CORS"
          fi

      - name: Update backend Container App env vars
        run: |
          BACKEND_APP=${{ secrets.BACKEND_CONTAINER_APP_NAME }}
          RG=${{ secrets.AZURE_RG }}
          VAULT_NAME=${{ secrets.KEY_VAULT_NAME }}

          echo "Fetching updated ALLOWED_HOSTS and CORS_ALLOWED_ORIGINS from Vault..."
          NEW_ALLOWED=$(az keyvault secret show --vault-name "$VAULT_NAME" --name "ALLOWED-HOSTS" --query "value" -o tsv)
          NEW_CORS=$(az keyvault secret show --vault-name "$VAULT_NAME" --name "CORS-ALLOWED-ORIGINS" --query "value" -o tsv)

          echo "Updating backend container app env vars..."
          
          az containerapp secret set --name "$BACKEND_APP" --resource-group "$RG" \
            --secrets "allowed-hosts=$NEW_ALLOWED cors-allowed-origins=$NEW_CORS"

      - name: Comment Preview URL
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸ§ª Preview deployed: https://${{ steps.vars.outputs.app }}.azurewebsites.net`
            })

  cleanup:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Azure Login
        uses: azure/login@v2.2.0
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Cleanup App Service and Plan
        run: |
          APP=pr-${{ github.event.number }}-chrona-frontend
          PLAN=pr-${{ github.event.number }}-chrona-plan

          echo "ðŸ§¹ Deleting Web App: $APP"
          az webapp delete --name "$APP" --resource-group ${{ secrets.AZURE_RG }} || echo "App may not exist."

          echo "ðŸ§¹ Deleting App Service Plan: $PLAN"
          az appservice plan delete --name "$PLAN" --resource-group ${{ secrets.AZURE_RG }} --yes || echo "Plan may not exist."

      - name: Remove Preview URL from ALLOWED_HOSTS and CORS_ALLOWED_ORIGINS
        run: |
          APP_URL="https://pr-${{ github.event.number }}-chrona-frontend.azurewebsites.net"
          VAULT_NAME=${{ secrets.KEY_VAULT_NAME }}

          echo "Fetching current ALLOWED_HOSTS and CORS_ALLOWED_ORIGINS..."
          EXISTING_ALLOWED=$(az keyvault secret show --vault-name "$VAULT_NAME" --name "ALLOWED-HOSTS" --query "value" -o tsv)
          EXISTING_CORS=$(az keyvault secret show --vault-name "$VAULT_NAME" --name "CORS-ALLOWED-ORIGINS" --query "value" -o tsv)

          echo "Removing APP_URL from ALLOWED_HOSTS..."
          UPDATED_ALLOWED=$(echo "$EXISTING_ALLOWED" | sed "s#${APP_URL},*##g" | sed 's#,,#,#g' | sed 's#^,\|,$##g')
          az keyvault secret set --vault-name "$VAULT_NAME" --name "ALLOWED-HOSTS" --value "$UPDATED_ALLOWED"

          echo "Removing APP_URL from CORS_ALLOWED_ORIGINS..."
          UPDATED_CORS=$(echo "$EXISTING_CORS" | sed "s#${APP_URL},*##g" | sed 's#,,#,#g' | sed 's#^,\|,$##g')
          az keyvault secret set --vault-name "$VAULT_NAME" --name "CORS-ALLOWED-ORIGINS" --value "$UPDATED_CORS"

      - name: Update backend Container App env vars
        run: |
          BACKEND_APP=${{ secrets.BACKEND_CONTAINER_APP_NAME }}
          RG=${{ secrets.AZURE_RG }}
          VAULT_NAME=${{ secrets.KEY_VAULT_NAME }}

          echo "Fetching updated ALLOWED_HOSTS and CORS_ALLOWED_ORIGINS..."
          NEW_ALLOWED=$(az keyvault secret show --vault-name "$VAULT_NAME" --name "ALLOWED-HOSTS" --query "value" -o tsv)
          NEW_CORS=$(az keyvault secret show --vault-name "$VAULT_NAME" --name "CORS-ALLOWED-ORIGINS" --query "value" -o tsv)

          echo "Updating backend container app env vars..."
          az containerapp secret set --name "$BACKEND_APP" --resource-group "$RG" \
            --secrets "allowed-hosts=$NEW_ALLOWED cors-allowed-origins=$NEW_CORS"

